<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="description" content="A simple and powerful chemistry calculator to analyze chemical compounds, calculate molar mass, and determine mass percentages. Perfect for students and professionals.">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-adsense-account" content="ca-pub-8948405948087873">
    <meta name="msvalidate.01" content="848A490F5967273EFF4F57D7327BB1F5" />
    <title>ChemFormulator: The Easy Chemistry Calculator</title>
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1200px;
            border-radius: 0 0 15px 15px;
            margin-bottom: 1.5rem;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.3rem;
        }

        header p {
            color: #666;
            font-size: 1rem;
            font-weight: 300;
        }

        .container {
            max-width: 1200px;
            width: 95%;
            margin: 0 auto 2rem auto;
            padding: 0 1rem;
            position: relative;
            z-index: 5;
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .flex-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .flex-row {
                grid-template-columns: 1fr;
            }
        }

        .compound-section, .calculator-section {
            background: linear-gradient(135deg, #f8f9ff, #e8ecff);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        .calculator-section {
            background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
            border-color: rgba(59, 130, 246, 0.15);
            margin-bottom: 1.5rem;
        }


        .compound-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .compound-section h2, .calculator-section h3 {
            color: #4a5568;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .calculator-section h3 {
            color: #1e3a8a;
        }

        .molecule-icon {
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
        }

        label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%;
            padding: 0.9rem;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            line-height: 1.4;
        }

        .formula-input-group {
            margin-bottom: 0.8rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        input.input-error {
            border-color: #e53e3e !important;
            box-shadow: 0 0 0 2px rgba(229, 62, 62, 0.2) !important;
        }
        .formula-feedback-message {
            font-size: 0.75rem;
            margin-top: -0.6rem;
            margin-bottom: 0.8rem;
            display: block;
            min-height: 1em;
        }
        .formula-feedback-message.error { color: #c53030; }
        .formula-feedback-message.success { color: #15803d; }
        .formula-feedback-message.warning { color: #ca8a04; }
        .formula-feedback-message.info { color: #4b5563; }

        .charge-check-btn {
            background-color: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.3rem 0.8rem;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        .charge-check-btn:hover {
            background-color: #e2e8f0;
            border-color: #cbd5e1;
        }

        .formula-input-container {
            position: relative;
        }

        .hydration-op-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.7rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hydration-op-btn.add {
            right: 6px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .hydration-op-btn.subtract {
            right: 62px;
            background-color: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .hydration-op-btn:hover {
            transform: translateY(-50%) scale(1.05);
        }

        .suggestions {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 130px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 100;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            top: 100%;
            left: 0;
            margin-top: 4px;
        }

        .suggestion-item {
            padding: 0.7rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f7f7f7;
            font-size: 0.9rem;
        }
        .suggestion-item:hover { background-color: #f8f9ff; }
        .suggestion-item:last-child { border-bottom: none; }

        .ion-selection-panel {
            background: linear-gradient(135deg, #fff9e6, #fff3cd);
            border-radius: 15px;
            padding: 1.5rem;
            border-left: 3px solid #f59e0b;
            margin: 1.5rem 0;
            animation: slideIn 0.4s ease-out;
        }

        .ion-selection-panel h3 {
            color: #92400e;
            margin-bottom: 0.8rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ion-selection-panel p {
            font-size: 0.9rem;
            color: #a16207;
            margin-bottom: 1rem;
        }

        .ion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .ion-btn {
            background: white;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 0.5rem 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .ion-btn:hover, .ion-btn.selected {
            background: #f59e0b;
            color: white;
            transform: translateY(-2px);
        }
        .ion-btn.selected {
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .flex-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem 1.5rem;
        }

        #dilutionCalculatorSection .flex-inputs {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        @media (min-width: 768px) {
            #dilutionCalculatorSection .flex-inputs {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) {
            #dilutionCalculatorSection .flex-inputs {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .action-buttons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem auto;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25);
            margin: 0;
        }

        .calculate-btn.dilution-calc-btn {
            background: linear-gradient(135deg, #38bdf8, #3b82f6);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);
        }
        .calculate-btn.dilution-calc-btn:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.35);
        }

        .calculate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.35);
        }
        .calculate-btn:active:not(:disabled) { transform: translateY(-1px); }
        .calculate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #b0b0e0;
        }

        .secondary-btn {
            background-color: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .secondary-btn:hover {
            background-color: #e2e8f0;
            border-color: #cbd5e1;
        }
/* --- ADD THIS ENTIRE BLOCK OF NEW CSS --- */

        .dilution-main-result {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            text-align: center;
            margin: 1rem 0;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .dilution-main-result-label {
            display: block;
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .dilution-main-result-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
        }

        .dilution-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        @media (max-width: 600px) {
            .dilution-grid { grid-template-columns: 1fr; }
        }

        .dilution-input-group h4 {
            font-size: 1rem;
            color: #1e3a8a;
            margin-bottom: 1rem;
            border-bottom: 1px solid #dbeafe;
            padding-bottom: 0.5rem;
        }

        .input-with-unit {
            display: flex;
            margin-bottom: 1rem;
        }


        .input-with-unit input {
            border-right: none;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            flex: 1; /* <-- ADD: Allows the input to grow and fill space */
            min-width: 0; /* <-- ADD: Important fix for flexbox in some browsers */
        }
        .input-with-unit select {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            background-color: #f8fafc;
            width: auto;
            min-width: 85px; /* <-- CHANGE: A slightly larger fixed width */
        }

        .dilution-secondary-output {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #dbeafe;
            font-size: 0.9rem;
            text-align: center;
            color: #475569;
        }
        .output-panel {
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border-radius: 15px;
            padding: 2rem;
            border-left: 3px solid #4CAF50;
            margin-top: 1.5rem;
            animation: slideIn 0.4s ease-out;
        }
        .dilution-output-panel {
            background: linear-gradient(135deg, #e0f2fe, #f0f9ff);
            border-left-color: #3b82f6;
            padding: 1.5rem;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .output-panel h2, .output-panel h3 {
            color: #2d5016;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .output-panel h3 {
            font-size: 1.1rem;
            color: #3f6212;
            border-bottom: 1px solid #dcfce7;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .dilution-results-grid {
            grid-template-columns: 1fr;
            gap: 0.8rem;
        }

        .result-item, .main-result-item {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            border: 1px solid #e8f5e9;
        }

        .main-result-item {
            background: linear-gradient(135deg, #f0fff4, #ffffff);
            border: 1px solid #4CAF50;
            grid-column: 1 / -1;
            padding: 1.5rem;
        }

        .result-value, .main-result-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d5016;
            margin-bottom: 0.4rem;
            word-wrap: break-word;
        }

        .main-result-value {
            font-size: 1.8rem;
            color: #15803d;
        }

        .result-label, .main-result-label {
            font-size: 0.85rem;
            color: #555;
            letter-spacing: 0.5px;
        }

        .main-result-label {
            font-size: 1rem;
        }

        #copyResultsBtn {
            display: block;
            margin: 1.5rem auto 0 auto;
        }

        .message-box {
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            font-size: 0.9rem;
            border-left-width: 4px;
            border-left-style: solid;
        }
        .error-message {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            color: #c53030;
            border-left-color: #e53e3e;
        }
        .info-note {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            color: #0c4a6e;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            border-left: 3px solid #0ea5e9;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        footer {
            background: rgba(40, 40, 40, 0.95);
            backdrop-filter: blur(8px);
            color: #e0e0e0;
            text-align: center;
            padding: 1.5rem;
            margin-top: 3rem;
            width: 100%;
            max-width: 1200px;
            border-radius: 15px 15px 0 0;
        }
        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .footer-links {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin: 0;
        }
        .footer-links a {
            color: #e0e0e0;
            text-decoration: none;
            transition: color 0.3s ease;
            font-size: 0.9rem;
        }
        .footer-links a:hover { color: #8a9bf8; }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="background-overlay"></div>

    <header>
        <h1>ChemFormulator</h1>
        <p>Enhanced Reagent Converter with Ion Conservation & Solution Calculations</p>
    </header>

    <div class="container">
        <div class="main-panel">
            <div class="flex-row">
                <div class="compound-section">
                    <h2><span class="molecule-icon">A</span>Original Compound</h2>

                    <label for="originalFormula">Chemical Formula</label>
                    <div class="formula-input-group">
                        <div class="formula-input-container">
                            <input type="text" id="originalFormula" placeholder="e.g. NaH‚ÇÇ(PO‚ÇÑ)" />
                            <div id="originalSuggestions" class="suggestions hidden"></div>
                            <button id="removeHydrationOriginal" class="hydration-op-btn subtract">-H‚ÇÇO</button>
                            <button id="addHydrationOriginal" class="hydration-op-btn add">+H‚ÇÇO</button>
                        </div>
                    </div>
                    <span id="originalFormulaFeedback" class="formula-feedback-message"></span>
                    <button id="checkChargeOriginalBtn" class="charge-check-btn hidden">Check Ionic Balance</button>

                    <label for="amount">Amount</label>
                    <input type="number" id="amount" placeholder="e.g. 100 (optional if M & V given)" step="any" />

                    <label for="unit">Unit</label>
                    <select id="unit">
                        <option value="mg" selected>Milligrams (mg)</option>
                        <option value="g">Grams (g)</option>
                        <option value="mol">Moles (mol)</option>
                    </select>
                </div>

                <div class="compound-section">
                    <h2><span class="molecule-icon">B</span>Replacement Compound</h2>

                    <label for="replacementFormula">Chemical Formula</label>
                    <div class="formula-input-group">
                        <div class="formula-input-container">
                            <input type="text" id="replacementFormula" placeholder="e.g. Na‚ÇÇH(PO‚ÇÑ)" />
                            <div id="replacementSuggestions" class="suggestions hidden"></div>
                            <button id="removeHydrationReplacement" class="hydration-op-btn subtract">-H‚ÇÇO</button>
                            <button id="addHydrationReplacement" class="hydration-op-btn add">+H‚ÇÇO</button>
                        </div>
                    </div>
                    <span id="replacementFormulaFeedback" class="formula-feedback-message"></span>
                    <button id="checkChargeReplacementBtn" class="charge-check-btn hidden">Check Ionic Balance</button>
                </div>
            </div>
            <div class="button-panel" style="display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px;">
                <button id="analyzeCompoundsBtn" class="calculate-btn main-action-btn" style="flex: 1;">
                    <span class="btn-text">Analyze Compounds</span>
                </button>
                <button id="clearAllBtn" class="secondary-btn" style="flex: 1;">Clear All</button>
            </div>
            <div class="calculator-section molarity-volume-section">
                <h3><span class="molecule-icon" style="font-size:14px;">üß™</span>Solution Parameters (Original Compound)</h3>
                <div class="flex-inputs">
                    <div>
                        <label for="molarity">Molarity</label>
                        <input type="number" id="molarity" placeholder="e.g. 200" step="any" />
                    </div>
                    <div>
                        <label for="molarityUnit">Molarity Unit</label>
                        <select id="molarityUnit">
                            <option value="M">M (mol/L)</option>
                            <option value="mM" selected>mM (mmol/L)</option>
                            <option value="uM">¬µM (¬µmol/L)</option>
                        </select>
                    </div>
                    <div>
                        <label for="volume">Volume</label>
                        <input type="number" id="volume" placeholder="e.g. 500" step="any" />
                    </div>
                    <div>
                        <label for="volumeUnit">Volume Unit</label>
                        <select id="volumeUnit">
                            <option value="mL" selected>Milliliters (mL)</option>
                            <option value="L">Liters (L)</option>
                        </select>
                    </div>
                </div>
                <div class="info-note">
                    üí° Provide Original Amount, <strong>OR</strong> Molarity & Volume. If Original Amount is given with Molarity <strong>OR</strong> Volume, the missing parameter will be calculated.
                </div>
            </div>

            <div id="dilutionCalculatorSection" class="calculator-section">
                <h3><span class="molecule-icon" style="font-size:14px;">üíß</span>Solution Dilution Calculator</h3>

                <div class="dilution-main-result">
                    <span class="dilution-main-result-label">Volume of Stock to Add (V‚ÇÅ)</span>
                    <span id="dilutionPrimaryResult" class="dilution-main-result-value">---</span>
                </div>

                <div class="dilution-grid">
                    <div class="dilution-input-group">
                        <h4>Stock Solution (C‚ÇÅV‚ÇÅ)</h4>
                        <label for="stockConc">Stock Concentration (C‚ÇÅ)</label>
                        <div class="input-with-unit">
                            <input type="number" id="stockConc" placeholder="e.g., 10" step="any">
                            <select id="stockConcUnit">
                                <option value="M">M</option>
                                <option value="mM" selected>mM</option>
                                <option value="uM">¬µM</option>
                                <option value="mg/mL">mg/mL</option>
                                <option value="ug/mL">¬µg/mL</option>
                                <option value="ng/mL">ng/mL</option>
                            </select>
                        </div>
                    </div>

                    <div class="dilution-input-group">
                        <h4>Final Solution (C‚ÇÇV‚ÇÇ)</h4>
                        <label for="finalConc">Final Concentration (C‚ÇÇ)</label>
                        <div class="input-with-unit">
                            <input type="number" id="finalConc" placeholder="e.g., 100" step="any">
                            <select id="finalConcUnit">
                                <option value="M">M</option>
                                <option value="mM" selected>mM</option>
                                <option value="uM">¬µM</option>
                                <option value="mg/mL">mg/mL</option>
                                <option value="ug/mL">¬µg/mL</option>
                                <option value="ng/mL">ng/mL</option>
                            </select>
                        </div>

                        <label for="finalVolume">Final Volume (V‚ÇÇ)</label>
                        <div class="input-with-unit">
                            <input type="number" id="finalVolume" placeholder="e.g., 50" step="any">
                            <select id="finalVolumeUnit">
                                <option value="L">L</option>
                                <option value="mL" selected>mL</option>
                                <option value="uL">¬µL</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="dilutionSecondaryResult" class="dilution-secondary-output hidden"></div>
                <div id="dilutionCalcError" class="message-box error-message hidden" style="margin-top: 1rem;"></div>
                <div class="button-panel" style="display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px;">
                    <button id="calculateDilutionBtn" class="calculate-btn dilution-calc-btn" style="flex: 1;">
                        <span class="btn-text">Calculate Dilution</span>
                    </button>
                    <button id="clearDilutionBtn" class="secondary-btn" style="flex: 1;">Clear Dilution</button>
                </div>
            </div>


            <div id="ionSelectionPanel" class="ion-selection-panel hidden">
                <h3><span class="molecule-icon" style="font-size:14px;">‚öõÔ∏è</span>Conserve Ion Concentration</h3>
                <p>Select the element/ion from the original compound's main chemical entity whose molar quantity you wish to conserve:</p>
                <div id="ionButtons" class="ion-buttons"></div>
            </div>

            <div id="outputPanel" class="output-panel hidden">
            </div>
            <div id="errorDisplay" class="message-box error-message hidden"></div>

        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>ChemFormulator is a free tool for biologists and chemists to simplify common lab calculations. This tool is for educational and research purposes only.</p>

            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8948405948087873"
            crossorigin="anonymous"></script>

            <div class="footer-links">
                <a href="mailto:dotansh@bgu.ac.il?subject=ChemFormulator%20Feedback">Report an Issue</a>
                <a href="https://github.com/dotansha/ChemCalc/tree/Publish" target="_blank" rel="noopener noreferrer">View on GitHub</a>
                <span>ChemFormulator v1.6</span>
            </div>
        </div>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DATA CONSTANTS ---
    const atomicWeights = { H: 1.008, He: 4.0026, Li: 6.94, Be: 9.0122, B: 10.81, C: 12.011, N: 14.007, O: 15.999, F: 18.998, Ne: 20.180, Na: 22.990, Mg: 24.305, Al: 26.982, Si: 28.085, P: 30.974, S: 32.06, Cl: 35.45, Ar: 39.948, K: 39.098, Ca: 40.078, Sc: 44.956, Ti: 47.867, V: 50.942, Cr: 51.996, Mn: 54.938, Fe: 55.845, Co: 58.933, Ni: 58.693, Cu: 63.546, Zn: 65.38, Ga: 69.723, Ge: 72.630, As: 74.922, Se: 78.971, Br: 79.904, Kr: 83.798, Rb: 85.468, Sr: 87.62, Y: 88.906, Zr: 91.224, Nb: 92.906, Mo: 95.95, Tc: 98, Ru: 101.07, Rh: 102.91, Pd: 106.42, Ag: 107.87, Cd: 112.41, In: 114.82, Sn: 118.71, Sb: 121.76, Te: 127.60, I: 126.90, Xe: 131.29, Cs: 132.91, Ba: 137.33, La: 138.91, Ce: 140.12, Pr: 140.91, Nd: 144.24, Pm: 145, Sm: 150.36, Eu: 151.96, Gd: 157.25, Tb: 158.93, Dy: 162.50, Ho: 164.93, Er: 167.26, Tm: 168.93, Yb: 173.05, Lu: 174.97, Hf: 178.49, Ta: 180.95, W: 183.84, Re: 186.21, Os: 190.23, Ir: 192.22, Pt: 195.08, Au: 196.97, Hg: 200.59, Tl: 204.38, Pb: 207.2, Bi: 208.98, Po: 209, At: 210, Rn: 222, Fr: 223, Ra: 226, Ac: 227, Th: 232.04, Pa: 231.04, U: 238.03, Np: 237, Pu: 244, Am: 243, Cm: 247, Bk: 247, Cf: 251, Es: 252, Fm: 257, Md: 258, No: 259, Lr: 262 };
    const waterMolarMass = (atomicWeights.H * 2) + atomicWeights.O;

    // --- DOM ELEMENT SELECTION ---
    const originalFormulaInput = document.getElementById('originalFormula');
    const replacementFormulaInput = document.getElementById('replacementFormula');
    const originalFormulaFeedback = document.getElementById('originalFormulaFeedback');
    const replacementFormulaFeedback = document.getElementById('replacementFormulaFeedback');
    const amountInput = document.getElementById('amount');
    const unitSelect = document.getElementById('unit');
    const molarityInput = document.getElementById('molarity');
    const molarityUnitSelect = document.getElementById('molarityUnit');
    const volumeInput = document.getElementById('volume');
    const volumeUnitSelect = document.getElementById('volumeUnit');
    const analyzeBtn = document.getElementById('analyzeCompoundsBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const ionSelectionPanel = document.getElementById('ionSelectionPanel');
    const ionButtonsContainer = document.getElementById('ionButtons');
    const outputPanel = document.getElementById('outputPanel');
    const errorDisplay = document.getElementById('errorDisplay');

    // --- PARSING LOGIC ---
    /**
     * Parses a chemical formula string into its composition, molar mass, and parts.
     * This function is designed to be robust and avoid infinite loops.
     * @param {string} formula The chemical formula string.
     * @returns {object|null} An object with parsed data or null on failure.
     */
    function parseFormula(formula) {
        if (!formula) return null;
        
        // Normalize formula: H‚ÇÇO -> H2O, remove spaces around operators
        const normalizedFormula = formula.replace(/‚ÇÇ/g, '2').replace(/‚ÇÉ/g, '3').replace(/‚ÇÑ/g, '4').replace(/‚ÇÖ/g, '5').replace(/‚ÇÜ/g, '6').replace(/‚Çá/g, '7').replace(/‚Çà/g, '8').replace(/‚Çâ/g, '9')
                                         .replace(/\s*[¬∑*]\s*/g, '¬∑');

        const hydrationMatch = normalizedFormula.match(/(.*)¬∑(\d*)H2O/);
        const mainFormula = hydrationMatch ? hydrationMatch[1] : normalizedFormula;
        const hydrationCount = hydrationMatch ? (hydrationMatch[2] ? parseInt(hydrationMatch[2], 10) : 1) : 0;

        const tokens = mainFormula.match(/([A-Z][a-z]?)(\d*)|(\()|(\))(\d*)/g);
        if (!tokens) return null;

        let composition = {};
        let stack = [{}];
        let multipliers = [1];

        for (const token of tokens) {
            const elementMatch = token.match(/([A-Z][a-z]?)(\d*)/);
            if (elementMatch) {
                const element = elementMatch[1];
                const count = elementMatch[2] ? parseInt(elementMatch[2], 10) : 1;
                if (atomicWeights[element]) {
                    stack[stack.length - 1][element] = (stack[stack.length - 1][element] || 0) + count;
                } else {
                    return { error: `Invalid element: ${element}` }; // Invalid element
                }
            } else if (token === '(') {
                stack.push({});
            } else if (token.startsWith(')')) {
                if (stack.length < 2) return { error: 'Mismatched parentheses.' }; // Mismatched parentheses
                
                let count = token.substring(1) ? parseInt(token.substring(1), 10) : 1;
                let top = stack.pop();
                let parent = stack[stack.length - 1];
                for (const el in top) {
                    parent[el] = (parent[el] || 0) + top[el] * count;
                }
            }
        }
        
        if (stack.length !== 1) return { error: 'Mismatched parentheses.' }; // Mismatched parentheses
        composition = stack[0];

        let mainMolarMass = 0;
        for (const el in composition) {
            mainMolarMass += composition[el] * atomicWeights[el];
        }

        const totalMolarMass = mainMolarMass + (hydrationCount * waterMolarMass);
        
        return {
            composition: composition,
            molarMass: totalMolarMass,
            mainPart: { formula: mainFormula, composition: composition, molarMass: mainMolarMass },
            hydration: { count: hydrationCount, mass: hydrationCount * waterMolarMass },
            error: null
        };
    }

    // --- VALIDATION AND UI FEEDBACK ---
    function validateFormula(inputElement, feedbackElement) {
        const formula = inputElement.value.trim();
        feedbackElement.textContent = '';
        inputElement.classList.remove('input-error');
        if (!formula) return false;

        const parsed = parseFormula(formula);
        if (parsed && !parsed.error) {
            feedbackElement.textContent = `Molar Mass: ${parsed.molarMass.toFixed(3)} g/mol`;
            feedbackElement.className = 'formula-feedback-message success';
            return true;
        } else {
            feedbackElement.textContent = parsed ? parsed.error : 'Invalid formula';
            feedbackElement.className = 'formula-feedback-message error';
            inputElement.classList.add('input-error');
            return false;
        }
    }

    // --- EVENT HANDLERS ---
    function handleHydrationChange(type, change) {
        const inputElement = document.getElementById(`${type}Formula`);
        const feedbackElement = document.getElementById(`${type}FormulaFeedback`);
        let formula = inputElement.value.trim();

        const hydrationRegex = /[¬∑*]\s*(\d*)\s*H‚ÇÇO/i;
        const match = formula.match(hydrationRegex);

        if (match) {
            const baseFormula = formula.substring(0, match.index).trim();
            const currentHydration = match[1] ? parseInt(match[1], 10) : 1;
            const newHydration = Math.max(0, currentHydration + change);

            if (newHydration > 1) {
                formula = `${baseFormula}¬∑${newHydration}H‚ÇÇO`;
            } else if (newHydration === 1) {
                formula = `${baseFormula}¬∑H‚ÇÇO`;
            } else {
                formula = baseFormula;
            }
        } else if (change > 0) {
            formula = formula ? `${formula}¬∑H‚ÇÇO` : 'H‚ÇÇO';
        }

        inputElement.value = formula;
        validateFormula(inputElement, feedbackElement);
    }
    
    function runAnalysis() {
        showLoading(true);
        clearResults();

        const isOriginalValid = validateFormula(originalFormulaInput, originalFormulaFeedback);
        const isReplacementValid = validateFormula(replacementFormulaInput, replacementFormulaFeedback);

        if (!isOriginalValid || !isReplacementValid) {
            showError("Please enter valid chemical formulas for both compounds.");
            showLoading(false);
            return;
        }

        const originalParsed = parseFormula(originalFormulaInput.value);
        const replacementParsed = parseFormula(replacementFormulaInput.value);

        displayIonSelection(originalParsed, replacementParsed);
        showLoading(false);
    }

    function displayIonSelection(originalParsed, replacementParsed) {
        ionButtonsContainer.innerHTML = '';
        const commonElements = Object.keys(originalParsed.mainPart.composition)
            .filter(el => replacementParsed.mainPart.composition.hasOwnProperty(el));

        if (commonElements.length === 0) {
            showError("No common elements found between the main parts of the compounds to base the conversion on.");
            return;
        }

        commonElements.forEach(el => {
            const btn = document.createElement('button');
            btn.className = 'ion-btn';
            btn.textContent = el;
            btn.dataset.ion = el;
            btn.addEventListener('click', (e) => {
                // Remove 'selected' from any other button
                ionButtonsContainer.querySelectorAll('.ion-btn').forEach(b => b.classList.remove('selected'));
                // Add 'selected' to the clicked button
                e.target.classList.add('selected');
                
                runFinalCalculation(originalParsed, replacementParsed, el);
            });
            ionButtonsContainer.appendChild(btn);
        });

        ionSelectionPanel.classList.remove('hidden');
    }

    function runFinalCalculation(originalParsed, replacementParsed, conservedIon) {
        const amount = parseFloat(amountInput.value);
        const unit = unitSelect.value;
        const molarity = parseFloat(molarityInput.value);
        const molarityUnit = molarityUnitSelect.value;
        const volume = parseFloat(volumeInput.value);
        const volumeUnit = volumeUnitSelect.value;

        let originalMoles = 0;

        // Determine original moles from inputs
        if (!isNaN(molarity) && !isNaN(volume)) {
            const molarityInM = molarity * (molarityUnit === 'mM' ? 1e-3 : molarityUnit === 'uM' ? 1e-6 : 1);
            const volumeInL = volume * (volumeUnit === 'mL' ? 1e-3 : 1);
            originalMoles = molarityInM * volumeInL;
        } else if (!isNaN(amount)) {
             if (unit === 'g') originalMoles = amount / originalParsed.molarMass;
             else if (unit === 'mg') originalMoles = (amount / 1000) / originalParsed.molarMass;
             else originalMoles = amount; // unit is 'mol'
        } else {
            showError("Please provide either Amount OR Molarity and Volume.");
            return;
        }

        if (originalMoles <= 0) {
             showError("Calculated amount of original compound is zero or negative. Please check inputs.");
             return;
        }
        
        const molesOfIon = originalMoles * originalParsed.mainPart.composition[conservedIon];
        const replacementMoles = molesOfIon / replacementParsed.mainPart.composition[conservedIon];
        const replacementMassG = replacementMoles * replacementParsed.molarMass;

        displayResults(originalParsed, replacementParsed, originalMoles, replacementMoles, replacementMassG, conservedIon);
    }

    function displayResults(original, replacement, originalMoles, replacementMoles, replacementMassG, ion) {
        outputPanel.innerHTML = `
            <h2><span class="molecule-icon">üìà</span>Conversion Results</h2>
            <p style="text-align:center; margin-top:-1rem; margin-bottom:1.5rem; color:#3f6212;">Based on conserving the molar amount of <strong>${ion}</strong>.</p>
            
            <div class="results-grid">
                <div class="main-result-item">
                    <div class="main-result-label">Required Amount of ${replacement.mainPart.formula}</div>
                    <div class="main-result-value">${(replacementMassG * 1000).toFixed(3)} mg</div>
                    <div class="result-label" style="font-size: 1rem;">(${(replacementMassG).toFixed(4)} g or ${replacementMoles.toExponential(3)} mol)</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Original Moles</div>
                    <div class="result-value">${originalMoles.toExponential(3)} mol</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Replacement Moles</div>
                    <div class="result-value">${replacementMoles.toExponential(3)} mol</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Original MW</div>
                    <div class="result-value">${original.molarMass.toFixed(3)} g/mol</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Replacement MW</div>
                    <div class="result-value">${replacement.molarMass.toFixed(3)} g/mol</div>
                </div>
            </div>`;
        outputPanel.classList.remove('hidden');
    }

    // --- HELPER FUNCTIONS ---
    function clearResults() {
        outputPanel.classList.add('hidden');
        outputPanel.innerHTML = '';
        ionSelectionPanel.classList.add('hidden');
        ionButtonsContainer.innerHTML = '';
        errorDisplay.classList.add('hidden');
        errorDisplay.textContent = '';
    }
    
    function clearAll() {
        originalFormulaInput.value = '';
        replacementFormulaInput.value = '';
        amountInput.value = '';
        molarityInput.value = '';
        volumeInput.value = '';
        originalFormulaFeedback.textContent = '';
        replacementFormulaFeedback.textContent = '';
        originalFormulaInput.classList.remove('input-error');
        replacementFormulaInput.classList.remove('input-error');
        clearResults();
    }
    
    function showError(message) {
        errorDisplay.textContent = message;
        errorDisplay.classList.remove('hidden');
    }

    function showLoading(isLoading) {
        const btnText = analyzeBtn.querySelector('.btn-text');
        if (isLoading) {
            analyzeBtn.disabled = true;
            btnText.innerHTML = '<span class="loading"></span> Analyzing...';
        } else {
            analyzeBtn.disabled = false;
            btnText.innerHTML = 'Analyze Compounds';
        }
    }

    // --- INITIAL EVENT LISTENERS ---
    originalFormulaInput.addEventListener('input', () => validateFormula(originalFormulaInput, originalFormulaFeedback));
    replacementFormulaInput.addEventListener('input', () => validateFormula(replacementFormulaInput, replacementFormulaFeedback));
    
    document.getElementById('addHydrationOriginal').addEventListener('click', () => handleHydrationChange('original', 1));
    document.getElementById('removeHydrationOriginal').addEventListener('click', () => handleHydrationChange('original', -1));
    document.getElementById('addHydrationReplacement').addEventListener('click', () => handleHydrationChange('replacement', 1));
    document.getElementById('removeHydrationReplacement').addEventListener('click', () => handleHydrationChange('replacement', -1));

    analyzeBtn.addEventListener('click', runAnalysis);
    clearAllBtn.addEventListener('click', clearAll);
    
    // Placeholder for dilution calculator logic if it were to be implemented
    document.getElementById('calculateDilutionBtn').addEventListener('click', () => {
         // This logic is separate and was not part of the reported bug.
         // For now, we can just show an alert.
         alert("Dilution calculator logic not implemented in this fix.");
    });
});
</script>
</body>
</html>
